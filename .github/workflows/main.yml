name: Live Streaming â€“ RABU - MINGGU

on:
  workflow_dispatch:
  schedule:
  #  - cron: "30 9 * * 1"  # Senin 16:30 WIB
  #  - cron: "0 10 * * 2"  # Selasa 17:00 WIB
  #  - cron: "0 11 * * 3"  # Rabu 18:00 WIB
  #  - cron: "45 1 * * 4" # Kamis 17:30 WIB
  #  - cron: "0 10 * * 5"  # Jumat 17:00 WIB
  #  - cron: "0 11 * * 6"  # Sabtu 18:00 WIB
  #  - cron: "30 9 * * 0"  # Minggu 16:30 WIB

jobs:
  live-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      STREAM_KEY: ${{ secrets.STREAM_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install FFmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg bc wget

      - name: Download videos (safe auto)
        run: |
          for i in $(seq -w 1 50); do
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listA_${i}.mp4 || true
            wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/listB_${i}.mp4 || true
          done
          wget -q https://github.com/whateverliveyt/whatever/releases/download/v1.0/intro.mp4 || true

      - name: Init state
        run: |
          ls listA_*.mp4 2>/dev/null > active.txt
          ls listB_*.mp4 2>/dev/null > reserve.txt
          : > recycle.txt

      - name: Health check
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          [ -z "$STREAM_KEY" ] && exit 1
          [ ! -s active.txt ] && exit 1

      - name: Live streaming
        env:
          STREAM_KEY: ${{ secrets.STREAM_KEY }}
        run: |
          COUNT=$(wc -l < active.txt)

          if [ "$COUNT" -ge 15 ]; then
            MAX_LOOP=1
          elif [ "$COUNT" -ge 8 ]; then
            MAX_LOOP=2
          else
            MAX_LOOP=3
          fi

          GAIN=$(awk 'BEGIN{srand(); print int(rand()*5)-2}')
          BRIGHT=$(awk 'BEGIN{srand(); printf "%.3f", (rand()*0.02 - 0.01)}')
          SAT=$(awk 'BEGIN{srand(); printf "%.3f", 1 + (rand()*0.02 - 0.01)}')

          LOOP=1
          while [ $LOOP -le $MAX_LOOP ]; do
            shuf active.txt > play_order.txt
            : > playlist.txt

            if [ -f intro.mp4 ] && [ $LOOP -eq 1 ]; then
              echo "file '$PWD/intro.mp4'" >> playlist.txt
            fi

            while read f; do
              echo "file '$PWD/$f'" >> playlist.txt
            done < play_order.txt

            ffmpeg -re -f concat -safe 0 -i playlist.txt               -filter:a "volume=${GAIN}dB"               -filter:v "eq=brightness=${BRIGHT}:saturation=${SAT}"               -c:v libx264 -preset veryfast -maxrate 3000k -bufsize 6000k               -pix_fmt yuv420p -g 50               -c:a aac -b:a 128k -ar 44100               -f flv "rtmp://a.rtmp.youtube.com/live2/$STREAM_KEY"

            LOOP=$((LOOP+1))
          done
